{% extends "base.html" %}
{% load static %}
{% load app_tags %}

{% block title %}
  {{ media_type|media_type_readable_plural }} - Yamtrack
{% endblock title %}

{% block content %}
  <h1 class="text-3xl font-bold mb-8 text-[#f4f4f5]">{{ media_type|media_type_readable_plural }}</h1>

  <div x-data="{ sort: '{{ current_sort }}', status: '{{ current_status }}', layout: '{{ current_layout }}', search: '{{ request.GET.search|default:'' }}', statusLabels: {
    {% for value, label in status_choices %}
      '{{ value }}': '{{ label }}'
      {% if not forloop.last %},{% endif %}

    {% endfor %}
    }, sortLabels: {
    {% for value, label in sort_choices %}
      '{{ value }}': '{{ label }}'
      {% if not forloop.last %},{% endif %}

    {% endfor %}
    } }">

    <!-- Form to manage state -->
    <form id="filter-form" class="hidden">
      <input type="hidden" name="sort" x-model="sort">
      <input type="hidden" name="status" x-model="status">
      <input type="hidden" name="search" x-model="search">
      <input type="hidden" name="layout" x-model="layout">
    </form>

    <div class="flex flex-col md:flex-row gap-4 mb-8">
      <!-- Search -->
      <div class="relative grow">
        <input placeholder="Search {{ media_type_plural }} in your list..."
               class="w-full py-3 pl-10 pr-4 bg-[#18181b] rounded-xl text-[#f4f4f5] border border-[#27272a] focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 appearance-none transition-all duration-200 placeholder-[#71717a] shadow-sm"
               type="text"
               x-model="search"
               hx-get="{% url 'medialist' media_type %}"
               hx-trigger="keyup changed delay:300ms, search"
               {% if media_list %} hx-target="{{ layout_class }}" {% else %} hx-target="#empty_list" {% endif %}
               hx-include="#filter-form"
               hx-indicator="#search-indicator">
        {% include "app/icons/magnifying-glass.svg" with classes="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-[#a1a1aa]" %}
        <div id="search-indicator"
             class="htmx-indicator absolute right-3 top-1/2 transform -translate-y-1/2">
          <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-500"></div>
        </div>
      </div>

      <div class="flex gap-2.5 flex-wrap">
        <!-- Filter by Status -->
        <div class="relative" x-data="{ open: false }">
          <button class="flex items-center px-4 py-3 bg-[#18181b] rounded-xl hover:bg-[#27272a] transition-all duration-200 cursor-pointer border border-[#27272a] shadow-sm text-[#f4f4f5]"
                  @click="open = !open"
                  @click.outside="open = false"
                  type="button">
            {% include "app/icons/funnel.svg" with classes="w-4 h-4 mr-2 text-orange-500" %}
            <span class="text-sm font-medium" x-text="statusLabels[status] || status || 'Status'"></span>
            {% include "app/icons/chevron-down.svg" with classes="w-3 h-3 ml-2 text-[#71717a]" %}
          </button>

          <div class="absolute z-20 mt-2 py-1.5 w-56 bg-[#18181b] rounded-xl shadow-xl overflow-hidden border border-[#27272a]"
               x-cloak
               x-show="open"
               x-transition:enter="transition ease-out duration-100"
               x-transition:enter-start="transform opacity-0 scale-95"
               x-transition:enter-end="transform opacity-100 scale-100"
               x-transition:leave="transition ease-in duration-75"
               x-transition:leave-start="transform opacity-100 scale-100"
               x-transition:leave-end="transform opacity-0 scale-95">
             <button hx-get="{% url 'medialist' media_type %}"
                     {% if media_list %} hx-target="{{ layout_class }}" {% else %} hx-target="#empty_list" {% endif %}
                     hx-include="#filter-form"
                     hx-indicator="#loading-indicator"
                     class="block w-full px-4 py-2.5 text-left text-sm transition-all duration-200 cursor-pointer rounded-lg mx-1 my-0.5"
                     :class="!status ? 'bg-blue-600 text-white font-semibold' : 'text-[#a1a1aa] hover:bg-[#27272a] hover:text-[#f4f4f5]'"
                     @click="status = ''; open = false"
                     type="button">All Statuses</button>
            {% for value, label in status_choices %}
              <button hx-get="{% url 'medialist' media_type %}"
                      {% if media_list %} hx-target="{{ layout_class }}" {% else %} hx-target="#empty_list" {% endif %}
                      hx-include="#filter-form"
                      hx-indicator="#loading-indicator"
                      class="block w-full px-4 py-2.5 text-left text-sm transition-all duration-200 cursor-pointer rounded-lg mx-1 my-0.5"
                      :class="status === '{{ value }}' ? 'bg-blue-600 text-white font-semibold' : 'text-[#a1a1aa] hover:bg-[#27272a] hover:text-[#f4f4f5]'"
                      @click="status = '{{ value }}'; open = false"
                      type="button">{{ label }}</button>
            {% endfor %}
          </div>
        </div>

        <!-- Sort by -->
        <div class="relative" x-data="{ open: false }">
          <button class="flex items-center px-4 py-3 bg-[#18181b] rounded-xl hover:bg-[#27272a] transition-all duration-200 cursor-pointer border border-[#27272a] shadow-sm text-[#f4f4f5]"
                  @click="open = !open"
                  @click.outside="open = false"
                  type="button">
            {% include "app/icons/arrows-up-down.svg" with classes="w-4 h-4 mr-2 text-blue-500" %}
            <span class="text-sm font-medium" x-text="sortLabels[sort] || sort || 'Sort'"></span>
            {% include "app/icons/chevron-down.svg" with classes="w-3 h-3 ml-2 text-[#71717a]" %}
          </button>

          <div class="absolute z-20 mt-2 py-1.5 w-56 bg-[#18181b] rounded-xl shadow-xl overflow-hidden border border-[#27272a]"
               x-cloak
               x-show="open"
               x-transition:enter="transition ease-out duration-100"
               x-transition:enter-start="transform opacity-0 scale-95"
               x-transition:enter-end="transform opacity-100 scale-100"
               x-transition:leave="transition ease-in duration-75"
               x-transition:leave-start="transform opacity-100 scale-100"
               x-transition:leave-end="transform opacity-0 scale-95">
            {% for value, label in sort_choices %}
              {% if media_type != MediaTypes.MOVIE.value or value != 'progress' %}
                <button hx-get="{% url 'medialist' media_type %}"
                        {% if media_list %} hx-target="{{ layout_class }}" {% else %} hx-target="#empty_list" {% endif %}
                        hx-include="#filter-form"
                        hx-indicator="#loading-indicator"
                        class="block w-full px-4 py-2.5 text-left text-sm transition-all duration-200 cursor-pointer rounded-lg mx-1 my-0.5"
                        :class="sort === '{{ value }}' ? 'bg-blue-600 text-white font-semibold' : 'text-[#a1a1aa] hover:bg-[#27272a] hover:text-[#f4f4f5]'"
                        @click="sort = '{{ value }}'; open = false"
                        type="button">{{ label }}</button>
              {% endif %}
            {% endfor %}
          </div>
        </div>

        <!-- Layout Toggle -->
        <div class="flex rounded-xl overflow-hidden border border-[#27272a] shadow-sm bg-[#18181b] p-1">
          <a :href="`{% url 'medialist' media_type %}?${search ? 'search=' + search + '&' : ''}${status !== 'all' ? 'status=' + status + '&' : ''}${sort !== 'score' ? 'sort=' + sort + '&' : ''}layout=grid`"
             class="p-2 cursor-pointer transition-all duration-200 rounded-lg"
             :class="layout === 'grid' ? 'bg-[#27272a] text-[#f4f4f5] shadow-sm' : 'text-[#71717a] hover:text-[#f4f4f5] hover:bg-[#27272a]/50'"
             title="Grid View"
             @click="layout = 'grid'">
            {% include "app/icons/four-square.svg" with classes="w-5 h-5" %}
          </a>
          <a :href="`{% url 'medialist' media_type %}?${search ? 'search=' + search + '&' : ''}${status !== 'all' ? 'status=' + status + '&' : ''}${sort !== 'score' ? 'sort=' + sort + '&' : ''}layout=table`"
             class="p-2 cursor-pointer transition-all duration-200 rounded-lg"
             :class="layout === 'table' ? 'bg-[#27272a] text-[#f4f4f5] shadow-sm' : 'text-[#71717a] hover:text-[#f4f4f5] hover:bg-[#27272a]/50'"
             title="Table View"
             @click="layout = 'table'">
            {% include "app/icons/table.svg" with classes="w-5 h-5" %}
          </a>
        </div>
      </div>
    </div>

    {% if not media_list %}
      <div id="empty_list"
           class="flex flex-col items-center justify-center py-32 bg-[#18181b] rounded-3xl border border-[#27272a] shadow-xl">
        <div class="text-center max-w-md mx-auto p-6">
          <div class="bg-[#27272a] rounded-full p-6 w-24 h-24 mx-auto mb-8 flex items-center justify-center border border-[#3f3f46] shadow-inner">
            {% include "app/icons/edit.svg" with classes="w-10 h-10 text-[#71717a]" %}
          </div>
          <h3 class="text-2xl font-bold mb-3 text-[#f4f4f5]">No {{ media_type|media_type_readable_plural }} Tracked Yet</h3>
          <p class="text-[#a1a1aa] mb-8 text-lg">
            Start tracking your {{ media_type_plural }} to keep a record of what you've {{ media_type|media_past_verb }}.
          </p>
            <a href="{{ media_type|sample_search }}"
               class="px-8 py-3.5 bg-blue-600 text-white rounded-xl hover:bg-blue-500 transition-all duration-200 shadow-lg hover:shadow-blue-500/30 font-semibold text-lg inline-flex items-center gap-2">
            {% include "app/icons/magnifying-glass.svg" with classes="w-5 h-5" %}
            Browse {{ media_type|media_type_readable_plural }}
          </a>
        </div>
      </div>
    {% elif current_layout == "grid" %}
      <div class="media-grid">{% include "app/components/media_grid_items.html" %}</div>
    {% else %}
      <div class="bg-[#18181b] p-6 rounded-3xl overflow-hidden max-w-[calc(100svw-4rem)] overflow-x-scroll border border-[#27272a] shadow-xl">
        <table class="w-full">
          <thead class="text-left text-[#a1a1aa] text-sm uppercase tracking-wider border-b border-[#27272a]">
            <tr>
              <th class="p-4 w-20"></th>
              <th class="p-4 pe-8 w-1/3">Title</th>
              <th class="p-4 text-center">Score</th>
              {% if media_type != MediaTypes.MOVIE.value %}<th class="p-4 text-center">Progress</th>{% endif %}
              {% if media_type == MediaTypes.TV.value %}<th class="p-4 text-center">Last Watched</th>{% endif %}
              <th class="p-4 text-center">Status</th>
              <th class="p-4 text-center">Start Date</th>
              <th class="p-4 text-center">End Date</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-[#27272a]">
            {% include "app/components/media_table_items.html" %}
          </tbody>
        </table>
      </div>
    {% endif %}

    <div id="loading-indicator" class="htmx-indicator text-center pt-8">
      <div class="inline-flex justify-center items-center">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
      </div>
    </div>
  </div>
{% endblock content %}
